<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lecteur PDN (lite)</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
    #wrap{height:100%;display:flex;flex-direction:column}
    #board{flex:1;min-height:0;display:flex;align-items:center;justify-content:center;background:#111;color:#fff}
    #bar{display:flex;gap:.5rem;align-items:center;justify-content:center;padding:.5rem;background:#f3efe6;border-top:1px solid #d8cfbf}
    button{padding:.4rem .7rem;border:1px solid #cdbfa9;background:#fff;border-radius:.4rem;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    #msg{padding:.5rem .75rem;background:#fff3cd;border-top:1px solid #ffe69c;color:#664d03;display:none}
    .mono{font-family:ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
<div id="wrap">
  <div id="board">
    <div id="loading" class="mono">Chargement du PDN…</div>
  </div>

  <div id="bar">
    <button id="prev">⟵</button>
    <button id="play">▶︎</button>
    <button id="next">⟶</button>
  </div>

  <div id="msg"></div>
</div>

<script>
(() => {
  const msg = document.getElementById('msg');
  const loading = document.getElementById('loading');

  function showError(text){
    loading.textContent = '';
    msg.style.display = 'block';
    msg.textContent = text;
  }

  // Récupère ?pdn=...
  const params = new URLSearchParams(location.search);
  const pdnParam = params.get('pdn');

  if (!pdnParam) {
    showError('Paramètre manquant : ajoute ?pdn=URL_OU_CHEMIN_DU_FICHIER.pdn');
    return;
  }

  // Résout proprement :
  // - si c’est une URL http(s) => on garde
  // - si c’est un chemin relatif => on le résout par rapport à ce lecteur
  let pdnUrl;
  try {
    if (/^https?:\/\//i.test(pdnParam)) {
      pdnUrl = pdnParam;
    } else {
      // ex: /PDN/xxx.pdn ou PDN/xxx.pdn
      pdnUrl = new URL(pdnParam, location.href).href;
    }
  } catch (e) {
    showError('URL PDN invalide : ' + pdnParam);
    return;
  }

  // Charge le PDN
  fetch(pdnUrl, { cache: 'no-store' })
    .then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.text();
    })
    .then(text => {
      if (!text || !text.includes('[Event')) {
        throw new Error('Contenu PDN inattendu (le fichier ne ressemble pas à un PDN).');
      }
      loading.textContent = '';

      // ICI : branche ton moteur d’animation existant
      // Si ton projet PDN_JEU expose déjà une fonction globale, appelle-la ici.
      // Exemple (à adapter selon ton code réel) :
      // window.PDN_JEU.init({ containerId:'board', prevId:'prev', nextId:'next', playId:'play', pdnText:text });

      // Placeholder visuel minimal si tu n’as pas encore branché l’init :
      const board = document.getElementById('board');
      board.innerHTML = '<div class="mono">PDN chargé ✅ (' + text.length + ' caractères)<br>Branche ici l’init du lecteur.</div>';
    })
    .catch(err => {
      showError('Impossible de charger le PDN : ' + pdnUrl + ' — ' + err.message);
    });
})();
</script>
</body>
</html>
