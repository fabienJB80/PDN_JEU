<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lecteur PDN (lite) - diagnostic</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{min-height:100%;display:flex;flex-direction:column}
    .top{padding:10px 12px;background:#f3efe6;border-bottom:1px solid #d8cfbf}
    .top .label{font-weight:700;margin-right:.5rem}
    .mono{font-family:ui-monospace,Consolas,monospace;font-size:13px;word-break:break-all}
    .main{flex:1;min-height:0;display:flex;flex-direction:column;background:#111;color:#fff}
    .status{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.15)}
    pre{margin:0;padding:10px 12px;overflow:auto;white-space:pre-wrap}
    .ok{color:#8ef58e}
    .err{color:#ffb3b3}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <span class="label">PDN:</span>
    <span id="pdnUrl" class="mono"></span>
  </div>

  <div class="main">
    <div id="status" class="status mono">Chargement…</div>
    <pre id="preview" class="mono"></pre>
  </div>
</div>

<script>
(() => {
  const elUrl = document.getElementById('pdnUrl');
  const elStatus = document.getElementById('status');
  const elPreview = document.getElementById('preview');

  function setStatus(text, cls){
    elStatus.textContent = text;
    elStatus.className = 'status mono ' + (cls || '');
  }

  // Affiche toutes les erreurs JS (sinon écran noir)
  window.addEventListener('error', (e) => {
    setStatus('ERREUR JS: ' + (e.message || e.type), 'err');
  });
  window.addEventListener('unhandledrejection', (e) => {
    setStatus('PROMISE REJECTED: ' + (e.reason?.message || e.reason), 'err');
  });

  const params = new URLSearchParams(location.search);
  const pdnParam = params.get('pdn');

  if (!pdnParam) {
    elUrl.textContent = '(manquant)';
    setStatus('ERREUR: ajoute ?pdn=... (URL ou chemin du fichier)', 'err');
    return;
  }

  // Résolution robuste : URL absolue ou chemin relatif/absolu
  let pdnUrl;
  try {
    if (/^https?:\/\//i.test(pdnParam)) {
      pdnUrl = pdnParam;
    } else {
      pdnUrl = new URL(pdnParam, location.href).href;
    }
  } catch (e) {
    elUrl.textContent = pdnParam;
    setStatus('ERREUR: URL PDN invalide', 'err');
    return;
  }

  elUrl.textContent = pdnUrl;

  fetch(pdnUrl, { cache: 'no-store' })
    .then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status + ' ' + r.statusText);
      return r.text();
    })
    .then(text => {
      const head = text.slice(0, 4000);
      const looksLikePDN = head.includes('[Event') || head.includes('[FEN') || head.includes('[Site');

      setStatus(
        'OK ' + text.length + ' caractères' + (looksLikePDN ? ' (PDN détecté ✅)' : ' (contenu inattendu ⚠️)'),
        looksLikePDN ? 'ok' : ''
      );

      // aperçu (début du fichier)
      elPreview.textContent = head;
    })
    .catch(err => {
      setStatus('IMPOSSIBLE DE CHARGER: ' + err.message, 'err');
      elPreview.textContent = '';
    });
})();
</script>
</body>
</html>
