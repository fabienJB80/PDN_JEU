<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OPL – lecteur PDN local</title>

<style>
:root{--light:#efe3cc;--dark:#b98a57;--w:480px}
html,body{margin:0;font-family:system-ui}
body{display:flex;justify-content:center;padding:12px}
.wrap{width:var(--w);display:flex;flex-direction:column;gap:8px}
.board{aspect-ratio:1/1;display:grid;grid-template:repeat(10,1fr)/repeat(10,1fr);border-radius:10px;overflow:hidden}
.sq{display:flex;align-items:center;justify-content:center}
.light{background:var(--light)}
.dark{background:var(--dark);position:relative}
.num{position:absolute;top:3px;left:5px;font-size:11px;color:#fff;opacity:.6}
.piece{width:70%;aspect-ratio:1/1;border-radius:50%}
.w{background:#f6f1e8}
.b{background:#111}
.bar{display:flex;gap:6px;justify-content:center}
button{padding:6px 10px;font-weight:700}
.msg{text-align:center;font-size:12px;color:#b00020}
</style>
</head>

<body>
<div class="wrap">
  <div id="board" class="board"></div>
  <div class="bar">
    <button id="first">⏮</button>
    <button id="prev">⟵</button>
    <button id="next">⟶</button>
    <button id="last">⏭</button>
  </div>
  <div id="info"></div>
  <div id="msg" class="msg">En attente du PDN…</div>
</div>

<script>
(() => {

const board=document.getElementById('board');
const msg=document.getElementById('msg');
const info=document.getElementById('info');

const pieces=new Map();
let moves=[],ply=0;

function rc(n){const i=n-1,r=Math.floor(i/5),k=i%5;return[r,(r%2?0:1)+2*k]}
function nrc(r,c){if((r+c)%2===0)return null;const k=r%2?c/2:(c-1)/2;return Number.isInteger(k)?r*5+k+1:null}

function reset(){
  pieces.clear();
  for(let i=31;i<=50;i++)pieces.set(i,'w');
  for(let i=1;i<=20;i++)pieces.set(i,'b');
}

function render(){
  board.innerHTML='';
  for(let r=0;r<10;r++)for(let c=0;c<10;c++){
    const sq=document.createElement('div');
    const d=(r+c)%2;sq.className='sq '+(d?'dark':'light');
    if(d){
      const n=nrc(r,c);
      const num=document.createElement('div');
      num.className='num';num.textContent=n;sq.appendChild(num);
      if(pieces.has(n)){
        const p=document.createElement('div');
        p.className='piece '+pieces.get(n);
        sq.appendChild(p);
      }
    }
    board.appendChild(sq);
  }
}

function parsePDN(t){
  t=t.replace(/\{[^}]*\}|;.*$/gm,' ').replace(/\b\d+\./g,' ');
  return t.split(/\s+/).filter(x=>/[-x]/.test(x)).map(m=>{
    const cap=m.includes('x');
    const p=m.split(/[-x]/).map(Number);
    return p.length>=2?{f:p[0],t:p[1],cap}:null;
  }).filter(Boolean);
}

function rebuild(i){
  reset();
  for(let j=0;j<i;j++){
    const m=moves[j];
    pieces.delete(m.f);
    pieces.set(m.t,'w');
  }
  ply=i;render();
  info.textContent=`Coup ${ply}/${moves.length}`;
}

window.addEventListener('message',e=>{
  if(!e.data||e.data.type!=='OPL_PDN')return;
  moves=parsePDN(e.data.pdn);
  rebuild(0);
  msg.textContent='';
});

document.getElementById('first').onclick=()=>rebuild(0);
document.getElementById('last').onclick =()=>rebuild(moves.length);
document.getElementById('prev').onclick =()=>ply&&rebuild(ply-1);
document.getElementById('next').onclick =()=>ply<moves.length&&rebuild(ply+1);

reset();render();

})();
</script>
</body>
</html>
