<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OPL – Open PDN Local Player</title>

<style>
:root{
  --panel:#f3efe6;
  --border:#d8cfbf;
  --light:#efe3cc;
  --dark:#b98a57;
  --w:480px;
}
html,body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
body{
  background:#fff;
  display:flex;
  justify-content:center;
  padding:12px;
}
.wrap{
  width:var(--w);
  max-width:var(--w);
  display:flex;
  flex-direction:column;
  gap:10px;
}
.topbar{
  text-align:center;
  font-weight:700;
  font-size:14px;
}
.board{
  width:100%;
  aspect-ratio:1/1;
  display:grid;
  grid-template-columns:repeat(10,1fr);
  grid-template-rows:repeat(10,1fr);
  outline:1px solid rgba(0,0,0,.15);
  border-radius:10px;
  overflow:hidden;
}
.sq{display:flex;align-items:center;justify-content:center}
.light{background:var(--light)}
.dark{background:var(--dark);position:relative}
.num{
  position:absolute;top:3px;left:5px;
  font-size:11px;opacity:.6;color:#fff
}
.piece{
  width:72%;aspect-ratio:1/1;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  box-shadow: inset 0 3px 0 rgba(255,255,255,.18),0 6px 12px rgba(0,0,0,.3);
}
.w{background:#f6f1e8}
.b{background:#1a1a1a}
.king::after{
  content:"K";
  font-weight:900;
  font-size:18px;
  color:rgba(255,255,255,.85);
}
.w.king::after{color:#000}
.bar{
  display:flex;gap:6px;justify-content:center;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;padding:8px;
}
button{
  padding:6px 10px;
  font-weight:800;
  border-radius:8px;
  border:1px solid #cdbfa9;
  background:#fff;
  cursor:pointer;
}
button:disabled{opacity:.5}
.info{text-align:center;font-size:13px}
.msg{
  text-align:center;
  font-size:12px;
  font-family:ui-monospace,Consolas,monospace;
  color:#b00020;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">OPL – lecteur PDN local</div>
  <div id="board" class="board"></div>

  <div class="bar">
    <button id="first">⏮</button>
    <button id="prev">⟵</button>
    <button id="next">⟶</button>
    <button id="last">⏭</button>
  </div>

  <div id="info" class="info"></div>
  <div id="msg" class="msg"></div>
</div>

<script>
(() => {

const boardEl = document.getElementById('board');
const infoEl  = document.getElementById('info');
const msgEl   = document.getElementById('msg');

const pieces = new Map();
let moves=[], ply=0;

function rcFromN(n){
  const i=n-1,r=Math.floor(i/5),k=i%5;
  return [r,(r%2===0)?1+2*k:2*k];
}
function nFromRC(r,c){
  if((r+c)%2===0) return null;
  const k=(r%2===0)?(c-1)/2:c/2;
  return Number.isInteger(k)?r*5+k+1:null;
}

function reset(){
  pieces.clear();
  for(let n=31;n<=50;n++) pieces.set(n,{c:'w',k:false});
  for(let n=1;n<=20;n++)  pieces.set(n,{c:'b',k:false});
}

function render(){
  boardEl.innerHTML='';
  for(let r=0;r<10;r++)for(let c=0;c<10;c++){
    const dark=(r+c)%2;
    const sq=document.createElement('div');
    sq.className='sq '+(dark?'dark':'light');
    if(dark){
      const n=nFromRC(r,c);
      const num=document.createElement('div');
      num.className='num';num.textContent=n;
      sq.appendChild(num);
      const p=pieces.get(n);
      if(p){
        const d=document.createElement('div');
        d.className='piece '+p.c+(p.k?' king':'');
        sq.appendChild(d);
      }
    }
    boardEl.appendChild(sq);
  }
}

function applyMove(m){
  const p=pieces.get(m.from);
  if(!p) return;
  pieces.delete(m.from);
  if(m.cap){
    const dr=Math.sign(m.tr-m.fr);
    const dc=Math.sign(m.tc-m.fc);
    let r=m.fr+dr,c=m.fc+dc;
    while(r!==m.tr){
      const n=nFromRC(r,c);
      if(n && pieces.has(n)){ pieces.delete(n); break; }
      r+=dr;c+=dc;
    }
  }
  pieces.set(m.to,p);
}

function rebuild(i){
  reset();
  for(let j=0;j<i;j++) applyMove(moves[j]);
  ply=i;render();
  infoEl.textContent=`Coup ${ply}/${moves.length}`;
}

function parsePDN(txt){
  txt=txt.replace(/\{[^}]*\}|;.*$/gm,' ');
  txt=txt.replace(/\b\d+\./g,' ');
  const t=txt.split(/\s+/).filter(x=>/[-x]/.test(x));
  let side='w',res=[];
  for(const m of t){
    const cap=m.includes('x');
    const p=m.split(/[-x]/).map(Number);
    if(p.length<2) continue;
    const [f,tg]=p;
    const [fr,fc]=rcFromN(f);
    const [tr,tc]=rcFromN(tg);
    res.push({from:f,to:tg,cap,fr,fc,tr,tc});
    side=side==='w'?'b':'w';
  }
  return res;
}

function loadLocalPDN(){
  try{
    const host=document.referrer
      ? window.parent.document
      : document;

    const src=host.getElementById('opl-pdn');
    if(!src) throw 'Ancre opl-pdn introuvable';

    const text=src.textContent.trim();
    if(!text) throw 'PDN vide';

    moves=parsePDN(text);
    rebuild(0);
    msgEl.textContent='';
  }catch(e){
    msgEl.textContent='OPL : '+e;
  }
}

document.getElementById('first').onclick=()=>rebuild(0);
document.getElementById('last').onclick =()=>rebuild(moves.length);
document.getElementById('prev').onclick =()=>ply&&rebuild(ply-1);
document.getElementById('next').onclick =()=>ply<moves.length&&rebuild(ply+1);

reset();render();loadLocalPDN();

})();
</script>
</body>
</html>
