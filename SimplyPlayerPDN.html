<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SimplyPlayerPDN</title>

<style>
:root{
  --panel:#f3efe6;
  --border:#d8cfbf;
  --light:#efe3cc;
  --dark:#b98a57;
  --w:480px;
}

html,body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
body{
  background:#fff;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:12px;
}

.wrap{
  width:var(--w);
  max-width:var(--w);
  display:flex;
  flex-direction:column;
  gap:10px;
}

.topbar{
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:center;
}

.topbar label{
  font-size:13px;
  color:#3b2a16;
  user-select:none;
}

select{
  flex:1;
  min-width:0;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:600;
  font-size:13px;
  color:#3b2a16;
}

/* SCORE */
.score{
  text-align:center;
  font-size:13px;
  font-weight:800;
  color:#3b2a16;
}
.score:empty{display:none}

/* BOARD */
.board{
  width:100%;
  aspect-ratio:1/1;
  display:grid;
  grid-template-columns:repeat(10,1fr);
  grid-template-rows:repeat(10,1fr);
  outline:1px solid rgba(0,0,0,.12);
  border-radius:10px;
  overflow:hidden;
  box-shadow:0 8px 30px rgba(0,0,0,.18);
  background:#000;
}

.sq{
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center;
}

.light{background:var(--light)}
.dark{background:var(--dark)}

/* NUMEROTATION VISIBLE */
.num{
  position:absolute;
  top:3px;
  left:5px;
  font-size:12px;
  font-weight:800;
  z-index:5;
  pointer-events:none;
  text-shadow:
    -1px 0 rgba(255,255,255,.9),
     1px 0 rgba(255,255,255,.9),
     0 -1px rgba(255,255,255,.9),
     0  1px rgba(255,255,255,.9),
     0  0 2px rgba(0,0,0,.35);
}

.dark .num{
  color:#fff;
  text-shadow:
    -1px 0 rgba(0,0,0,.8),
     1px 0 rgba(0,0,0,.8),
     0 -1px rgba(0,0,0,.8),
     0  1px rgba(0,0,0,.8);
}

.piece{
  width:72%;
  aspect-ratio:1/1;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: inset 0 3px 0 rgba(255,255,255,.18), 0 6px 12px rgba(0,0,0,.30);
  border:1px solid rgba(0,0,0,.30);
  position:relative;
  z-index:2;
}

.w{background:#f6f1e8}
.b{background:#1a1a1a}

.king::after{
  content:"K";
  font-weight:800;
  font-size:18px;
  color:rgba(255,255,255,.85);
  text-shadow:0 1px 0 rgba(0,0,0,.6);
}
.w.king::after{
  color:rgba(0,0,0,.75);
  text-shadow:none;
}

/* CONTROLS */
.bar{
  display:flex;
  gap:6px;
  align-items:center;
  justify-content:center;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px;
}

button{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #cdbfa9;
  background:#fff;
  cursor:pointer;
  font-weight:800;
  min-width:44px;
  font-size:14px;
}

button:disabled{opacity:.55;cursor:not-allowed}

.info{
  flex:1;
  text-align:center;
  font-size:13px;
  color:#3b2a16;
  padding:0 8px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.msg{
  color:#b00020;
  font-family:ui-monospace,Consolas,monospace;
  font-size:12px;
  text-align:center;
  min-height:16px;
}
</style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <label for="gameSel">Partie</label>
    <select id="gameSel">
      <option>Chargement…</option>
    </select>
  </div>

  <div id="score" class="score"></div>

  <div id="board" class="board"></div>

  <div class="bar">
    <button id="first">⏮</button>
    <button id="prev">⟵</button>
    <button id="play">▶︎</button>
    <button id="next">⟶</button>
    <button id="last">⏭</button>
    <div id="info" class="info">Chargement…</div>
  </div>

  <div id="msg" class="msg"></div>
</div>

<script>
let games=[],moves=[],plyIndex=0,currentGameIndex=0;

/* ---------- PDN Helpers ---------- */
function getTag(txt,name){
  const re=new RegExp("^\\s*\\["+name+"\\s+\"([^\"]*)\"\\]\\s*$","mi");
  const m=txt.match(re);
  return m?m[1]:"";
}

function labelGame(i,gameText){
  const w=(getTag(gameText,'White')||'').trim();
  const b=(getTag(gameText,'Black')||'').trim();
  const r=(getTag(gameText,'Result')||'').trim();
  const both=(w&&b)?w+" / "+b:(w||b||"Partie");
  return r?`${i+1} — ${both} — ${r}`:`${i+1} — ${both}`;
}

function updateScoreLine(){
  const el=document.getElementById('score');
  const r=getTag(games[currentGameIndex],'Result');
  el.textContent=(r&&r!=="*")?"Score : "+r:"";
}

/* ---------- Simplified PDN parser ---------- */
function splitGames(txt){
  const parts=txt.split(/\n(?=\[Event )/g);
  return parts;
}

function buildMoves(gameText){
  const body=gameText.replace(/^\s*\[[^\]]+\]\s*$/gmi,'')
                     .replace(/\{[^}]*\}/g,'')
                     .replace(/\b(1-0|0-1|1\/2-1\/2|\*)\b/g,'');
  const tokens=body.match(/\d+\.\s*\.{0,2}\s*[^ ]+/g)||[];
  return tokens;
}

/* ---------- Basic Board ---------- */
const board=document.getElementById('board');
function renderBoard(){
  board.innerHTML='';
  for(let r=0;r<10;r++){
    for(let c=0;c<10;c++){
      const sq=document.createElement('div');
      const dark=(r+c)%2===1;
      sq.className='sq '+(dark?'dark':'light');
      if(dark){
        const n=r*5+Math.floor(c/2)+1;
        const num=document.createElement('div');
        num.className='num';
        num.textContent=n;
        sq.appendChild(num);
      }
      board.appendChild(sq);
    }
  }
}

/* ---------- Load ---------- */
async function init(){
  renderBoard();
  const params=new URLSearchParams(location.search);
  const url=params.get('pdn');
  if(!url){document.getElementById('msg').textContent="Ajouter ?pdn=URL";return;}
  const text=await fetch(url).then(r=>r.text());
  games=splitGames(text);
  const sel=document.getElementById('gameSel');
  sel.innerHTML='';
  games.forEach((g,i)=>{
    const opt=document.createElement('option');
    opt.value=i;
    opt.textContent=labelGame(i,g);
    sel.appendChild(opt);
  });
  sel.addEventListener('change',e=>{
    currentGameIndex=parseInt(e.target.value);
    updateScoreLine();
  });
  currentGameIndex=0;
  updateScoreLine();
}

init();
</script>
</body>
</html>
